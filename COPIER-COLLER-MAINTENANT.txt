â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸš€ CRÃ‰ATION SUPER ADMIN - COPIER-COLLER CE SCRIPT MAINTENANT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ PROBLÃˆME IDENTIFIÃ‰ :
   - Le compte existe dans auth.users (ID: 84401dfc-f23e-46e7-b201-868f2140ab73)
   - MAIS le profil manque dans public.profiles
   - ET le rÃ´le manque dans public.user_roles
   - Erreur RLS : "infinite recursion" empÃªche la crÃ©ation

âœ… SOLUTION :
   ExÃ©cuter ce script SQL qui dÃ©sactive temporairement RLS

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“‹ Ã‰TAPES Ã€ SUIVRE (2 minutes)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Ouvrez Supabase SQL Editor :
   ğŸ‘‰ https://supabase.com/dashboard/project/xfxqwlbqysiezqdpeqpv/sql/new

2. Copiez-collez ce script COMPLET ci-dessous :

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

-- SCRIPT FINAL - CRÃ‰ATION PROFIL SUPER ADMIN
-- RÃ©sout le problÃ¨me "infinite recursion"

ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles DISABLE ROW LEVEL SECURITY;

INSERT INTO public.profiles (
    id,
    email,
    full_name,
    phone,
    organization,
    created_at,
    updated_at
)
VALUES (
    '84401dfc-f23e-46e7-b201-868f2140ab73',
    '33661002616@ndjobi.com',
    'Super Administrateur',
    '+33661002616',
    'Administration SystÃ¨me',
    NOW(),
    NOW()
)
ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    full_name = EXCLUDED.full_name,
    phone = EXCLUDED.phone,
    organization = EXCLUDED.organization,
    updated_at = NOW();

INSERT INTO public.user_roles (
    user_id,
    role,
    created_at
)
VALUES (
    '84401dfc-f23e-46e7-b201-868f2140ab73',
    'super_admin',
    NOW()
)
ON CONFLICT (user_id) DO UPDATE SET 
    role = EXCLUDED.role,
    created_at = NOW();

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

SELECT 
    'âœ… COMPTE SUPER ADMIN CONFIGURÃ‰' as status,
    u.id,
    u.email,
    u.phone,
    p.full_name,
    p.organization,
    ur.role
FROM auth.users u
LEFT JOIN public.profiles p ON u.id = p.id
LEFT JOIN public.user_roles ur ON u.id = ur.user_id
WHERE u.id = '84401dfc-f23e-46e7-b201-868f2140ab73';

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3. Cliquez sur "RUN" (ou "ExÃ©cuter")

4. VÃ©rifiez le rÃ©sultat :
   âœ… Vous DEVEZ voir une ligne avec :
      - email: 33661002616@ndjobi.com
      - full_name: Super Administrateur
      - role: super_admin

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ§ª TEST IMMÃ‰DIAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AprÃ¨s avoir exÃ©cutÃ© le script :

1. Allez sur : /auth/super-admin

2. Entrez le PIN : 999999

3. Cliquez : "Se connecter"

4. âœ… SUCCÃˆS : Vous Ãªtes redirigÃ© vers /dashboard/super-admin

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“Š LOGS ATTENDUS (Console F12)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AprÃ¨s le script SQL, les logs dans la console devront montrer :

ğŸ” DÃ©marrage authentification Super Admin...
ğŸ” VÃ©rification du PIN...
âœ… PIN correct
ğŸ” Recherche du profil Super Admin...
âœ… Profil trouvÃ©: {...}          ğŸ‘ˆ PLUS D'ERREUR ICI !
ğŸ” VÃ©rification du rÃ´le...
âœ… RÃ´le super_admin confirmÃ©     ğŸ‘ˆ RÃ”LE TROUVÃ‰ !
ğŸ”§ CrÃ©ation de la session locale...
âœ… Session Super Admin crÃ©Ã©e avec succÃ¨s

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ’¡ C'EST TOUT !
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Le problÃ¨me Ã©tait l'erreur "infinite recursion" dans les politiques RLS.
Ce script la contourne en dÃ©sactivant/rÃ©activant RLS temporairement.

MAINTENANT, EXÃ‰CUTEZ LE SCRIPT ! ğŸš€

