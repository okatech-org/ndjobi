.PHONY: help install dev build test clean deploy

help:
	@echo "ğŸ“˜ iAsted Backend - Commandes disponibles:"
	@echo ""
	@echo "  make install       - Installer les dÃ©pendances"
	@echo "  make dev           - Lancer en mode dÃ©veloppement (Docker)"
	@echo "  make dev-local     - Lancer en mode dÃ©veloppement (local)"
	@echo "  make build         - Build l'image Docker"
	@echo "  make test          - Lancer les tests"
	@echo "  make lint          - VÃ©rifier le code (black, flake8)"
	@echo "  make format        - Formater le code"
	@echo "  make clean         - Nettoyer les fichiers temporaires"
	@echo "  make migrate       - Appliquer les migrations DB"
	@echo "  make logs          - Voir les logs Docker"
	@echo "  make deploy        - DÃ©ployer en production (K8s)"
	@echo ""

install:
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	pip install --upgrade pip
	pip install -r requirements.txt

dev:
	@echo "ğŸš€ DÃ©marrage en mode dÃ©veloppement (Docker)..."
	docker-compose up -d
	@echo "âœ… API disponible sur http://localhost:8000"
	@echo "ğŸ“Š Grafana: http://localhost:3001 (admin/admin)"
	@echo "ğŸ° RabbitMQ: http://localhost:15672 (guest/guest)"

dev-local:
	@echo "ğŸš€ DÃ©marrage en mode dÃ©veloppement (local)..."
	uvicorn app.main:app --reload --port 8000

build:
	@echo "ğŸ”¨ Build de l'image Docker..."
	docker build -t iasted-api:latest --target production .

test:
	@echo "ğŸ§ª Lancement des tests..."
	pytest tests/ -v --cov=app --cov-report=html
	@echo "âœ… Rapport de couverture: htmlcov/index.html"

test-watch:
	@echo "ğŸ§ª Tests en mode watch..."
	pytest-watch tests/ -v

lint:
	@echo "ğŸ” VÃ©rification du code..."
	flake8 app/ tests/ --max-line-length=100
	mypy app/

format:
	@echo "âœ¨ Formatage du code..."
	black app/ tests/
	isort app/ tests/

clean:
	@echo "ğŸ§¹ Nettoyage..."
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache .coverage htmlcov/

migrate:
	@echo "ğŸ—„ï¸ Application des migrations..."
	alembic upgrade head

migrate-create:
	@echo "ğŸ“ CrÃ©ation d'une nouvelle migration..."
	@read -p "Description de la migration: " desc; \
	alembic revision --autogenerate -m "$$desc"

db-reset:
	@echo "âš ï¸ RÃ©initialisation de la base de donnÃ©es..."
	@read -p "Confirmer la rÃ©initialisation (yes/no)? " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		alembic downgrade base; \
		alembic upgrade head; \
		echo "âœ… Base rÃ©initialisÃ©e"; \
	fi

logs:
	@echo "ğŸ“œ Logs Docker..."
	docker-compose logs -f api

shell:
	@echo "ğŸš Shell interactif..."
	docker-compose exec api /bin/bash

redis-cli:
	@echo "ğŸ’¾ Redis CLI..."
	docker-compose exec redis redis-cli

psql:
	@echo "ğŸ˜ PostgreSQL CLI..."
	docker-compose exec postgres psql -U iasted -d iasted_db

stop:
	@echo "ğŸ›‘ ArrÃªt des services..."
	docker-compose down

restart:
	@echo "ğŸ”„ RedÃ©marrage..."
	docker-compose restart api

deploy-terraform:
	@echo "â˜ï¸ DÃ©ploiement infrastructure Terraform..."
	cd ../infrastructure/terraform && \
	terraform init && \
	terraform apply

deploy-k8s:
	@echo "â˜¸ï¸ DÃ©ploiement Kubernetes..."
	kubectl apply -f ../infrastructure/kubernetes/base/
	kubectl rollout status deployment/iasted-api -n iasted

deploy: deploy-terraform deploy-k8s
	@echo "âœ… DÃ©ploiement complet terminÃ©"

status:
	@echo "ğŸ“Š Status des services..."
	docker-compose ps

health:
	@echo "ğŸ¥ VÃ©rification santÃ© API..."
	curl -s http://localhost:8000/health | jq

metrics:
	@echo "ğŸ“ˆ MÃ©triques Prometheus..."
	curl -s http://localhost:8000/metrics | head -20

