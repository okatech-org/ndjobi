<!DOCTYPE html>
<html>
<head>
    <title>Test Auth NDJOBI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .account { margin: 10px; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { margin: 5px; padding: 10px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>üîß Test d'Authentification NDJOBI</h1>
    
    <div id="status">Status: En attente...</div>
    
    <h2>Comptes D√©mo</h2>
    <div>
        <button onclick="testLogin('24177777000@ndjobi.ga', '123456', 'Super Admin')">
            ‚ö° Super Admin (77777000)
        </button>
        <button onclick="testLogin('24177777003@ndjobi.ga', '123456', 'Admin')">
            üëë Admin (77777003)
        </button>
        <button onclick="testLogin('24177777002@ndjobi.ga', '123456', 'Agent')">
            üë• Agent (77777002)
        </button>
        <button onclick="testLogin('24177777001@ndjobi.ga', '123456', 'Citoyen')">
            üë§ Citoyen (77777001)
        </button>
    </div>
    
    <h2>Actions</h2>
    <div>
        <button onclick="getCurrentUser()">üìã Utilisateur Actuel</button>
        <button onclick="checkRole()">üîç V√©rifier R√¥le</button>
        <button onclick="signOut()">üö™ D√©connexion</button>
    </div>
    
    <div id="result" class="result"></div>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'http://127.0.0.1:54321';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function setStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = isError ? 'error' : 'success';
        }
        
        function setResult(data) {
            document.getElementById('result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        async function testLogin(email, password, name) {
            setStatus(`Connexion ${name}...`);
            
            try {
                // Essayer de se connecter
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    // Si l'utilisateur n'existe pas, le cr√©er
                    if (error.message.includes('Invalid login')) {
                        setStatus(`Cr√©ation du compte ${name}...`);
                        
                        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: { full_name: name }
                            }
                        });
                        
                        if (signUpError) throw signUpError;
                        
                        // Se reconnecter
                        const { data: reLoginData, error: reLoginError } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        
                        if (reLoginError) throw reLoginError;
                        
                        setStatus(`‚úÖ ${name} cr√©√© et connect√© !`);
                        setResult(reLoginData);
                    } else {
                        throw error;
                    }
                } else {
                    setStatus(`‚úÖ ${name} connect√© !`);
                    setResult(data);
                }
                
                // V√©rifier le r√¥le apr√®s connexion
                setTimeout(() => checkRole(), 1000);
                
            } catch (error) {
                setStatus(`‚ùå Erreur: ${error.message}`, true);
                setResult(error);
            }
        }
        
        async function getCurrentUser() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error) {
                setStatus('‚ùå Pas d\'utilisateur connect√©', true);
                setResult(error);
            } else if (user) {
                setStatus('‚úÖ Utilisateur trouv√©');
                setResult(user);
            } else {
                setStatus('‚ö†Ô∏è Aucun utilisateur');
                setResult(null);
            }
        }
        
        async function checkRole() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                setStatus('‚ùå Pas d\'utilisateur connect√©', true);
                return;
            }
            
            const { data: roleData, error } = await supabase
                .from('user_roles')
                .select('role')
                .eq('user_id', user.id)
                .single();
            
            if (error) {
                setStatus('‚ö†Ô∏è Pas de r√¥le assign√©', true);
                setResult({ message: 'Ex√©cutez le SQL fix-demo-accounts.sql dans Supabase Studio' });
            } else {
                setStatus(`‚úÖ R√¥le: ${roleData.role}`);
                setResult(roleData);
            }
        }
        
        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                setStatus('‚ùå Erreur d√©connexion', true);
            } else {
                setStatus('‚úÖ D√©connect√©');
                setResult({});
            }
        }
        
        // V√©rifier l'√©tat initial
        getCurrentUser();
    </script>
</body>
</html>
