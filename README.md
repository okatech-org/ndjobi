# üö® NDJOBI - Plateforme Anti-Corruption du Gabon

## üìã **Vue d'ensemble**

**NDJOBI** est une plateforme web s√©curis√©e permettant aux citoyens gabonais de d√©noncer anonymement la corruption et de prot√©ger leurs innovations avec un horodatage blockchain infalsifiable.

### üéØ **Fonctionnalit√©s principales**
- üö® **Signalements anonymes** de corruption via chatbot IA
- üõ°Ô∏è **Protection de projets** avec certificats blockchain
- üë• **Syst√®me de r√¥les** (Citoyen, Agent DGSS, Admin, Super Admin)
- üó∫Ô∏è **G√©olocalisation** et visualisation des cas
- üîê **S√©curit√© maximale** avec chiffrement et anonymat garanti
- ü§ñ **iAsted - Assistant IA Vocal Pr√©sidentiel** pour l'administration

---

## ü§ñ **iAsted - Assistant IA Vocal Pr√©sidentiel**

### **Vue d'ensemble**
**iAsted** est un assistant IA conversationnel multimodal (texte et voix) con√ßu pour l'administration pr√©sidentielle. Il offre une interface naturelle et intuitive pour interagir avec le syst√®me NDJOBI via des conversations vocales ou textuelles en temps r√©el.

### **üéØ Objectifs**
- Fournir une interface conversationnelle naturelle pour l'administration
- Permettre l'acc√®s mains-libres aux fonctionnalit√©s via commandes vocales
- Offrir des r√©ponses contextuelles et personnalis√©es selon le r√¥le de l'utilisateur
- Garantir une exp√©rience utilisateur fluide avec des transitions d'√©tats visuelles

### **üîê Contr√¥le d'acc√®s**
L'acc√®s √† iAsted est strictement contr√¥l√© par r√¥le :
- ‚úÖ **Super Admin** : Acc√®s complet √† toutes les fonctionnalit√©s
- ‚úÖ **Admin (Pr√©sident)** : Acc√®s aux fonctionnalit√©s d'administration
- ‚úÖ **Sub Admin** : Acc√®s aux fonctionnalit√©s de sous-administration
- ‚ùå **Agent, User** : Pas d'acc√®s √† iAsted

### **üì± Interface utilisateur**

#### **Bouton flottant sph√©rique**
- **Design** : Bouton 3D avec animations organiques (battements de c≈ìur, ondes, respiration)
- **Position** : D√©pla√ßable par drag-and-drop sur toute la surface de l'√©cran
- **Persistance** : La position est sauvegard√©e dans le localStorage
- **Visibilit√©** : Visible uniquement pour les r√¥les autoris√©s

#### **√âtats visuels du bouton**
Le bouton affiche diff√©rentes ic√¥nes selon l'√©tat actuel :

| √âtat | Ic√¥ne | Animation | Description |
|------|-------|-----------|-------------|
| **Inactif** | Alternance (iAsted/Mic/Chat/Brain) | Rotation douce | Alterne toutes les ic√¥nes disponibles |
| **√âcoute** | üé§ Microphone | Ondes + contractions intensives | D√©tection de la parole utilisateur |
| **Parole** | üìù Texte "iAsted" | Pulsations douces | iAsted parle √† l'utilisateur |
| **Traitement** | üß† Cerveau | Rotation + √©clat | Analyse et r√©flexion en cours |
| **Interface ouverte** | üí¨ Chat | Statique | Interface de chat affich√©e |

#### **Animations organiques**
Le bouton poss√®de des animations naturelles qui s'intensifient selon l'action :
- **Membranes organiques** : Palpitations et expansions
- **Ondes √©mises** : Propagation synchronis√©e avec les battements
- **Contractions musculaires** : R√©ponse aux interactions utilisateur
- **Rayons lumineux** : Effets visuels adaptatifs

### **üéôÔ∏è Modes d'interaction**

#### **1. Mode Texte**
**Activation** : Simple clic sur le bouton iAsted
- Interface de chat s'ouvre √† c√¥t√© du bouton
- Saisie de texte classique avec historique
- R√©ponses instantan√©es en texte
- Sauvegarde automatique de la conversation

#### **2. Mode Vocal**
**Activation** : Double clic sur le bouton iAsted

**Flux de conversation :**
```
1. Double-clic ‚Üí Message de salutation vocal
2. D√©but d'√©coute automatique (VAD activ√©)
3. D√©tection de fin de parole (silence de 800ms)
4. Message de transition : "Laissez-moi r√©fl√©chir..."
5. Traitement de la demande (√©tat cerveau)
6. R√©ponse vocale compl√®te
7. Retour √† l'√©tat inactif
```

**Caract√©ristiques vocales :**
- D√©tection automatique de fin de parole (VAD adaptatif)
- Transcription en temps r√©el (Deepgram)
- Synth√®se vocale naturelle (ElevenLabs - voix Charlotte FR)
- Fallback sur Web Speech API si √©chec
- Gestion du contexte conversationnel

### **‚öôÔ∏è Architecture technique**

#### **Services principaux**

##### **1. IAstedService** (`src/services/iAstedService.ts`)
Service de gestion des conversations et interactions avec l'IA.

**Fonctionnalit√©s :**
- Envoi de messages √† l'IA (Lovable AI - Gemini 2.5 Flash)
- Gestion du contexte conversationnel
- Adaptation du syst√®me prompt selon le r√¥le utilisateur
- Gestion des erreurs et retry automatique

**Prompts syst√®me par r√¥le :**
- **Super Admin** : "Asted, assistant syst√®me avec acc√®s complet"
- **Admin (Pr√©sident)** : "Excellence, assistant pr√©sidentiel formel"
- **Sub Admin** : "Assistant administratif avec ton professionnel"

##### **2. IAstedVoiceService** (`src/services/iAstedVoiceService.ts`)
Service de gestion des fonctionnalit√©s vocales (STT et TTS).

**Speech-to-Text (STT) :**
- API principale : **Deepgram** via edge function (`iasted-stt`)
- Codec : audio/webm avec opus
- Fallback : Web Speech API (moins pr√©cis)
- Configuration : √©choCancellation, noiseSuppression, autoGainControl

**Text-to-Speech (TTS) :**
- API principale : **ElevenLabs** via edge function (`iasted-tts`)
- Voix : Charlotte (FR) - ID: `XB0fDUnXU5powFXDhCwa`
- Format : audio/mpeg (MP3)
- Fallback : Web Speech API avec voix fran√ßaise
- Attente de fin de lecture pour synchronisation des √©tats

**Gestion de l'enregistrement :**
- MediaRecorder avec collecte de chunks
- D√©tection de dur√©e minimale (1000 bytes)
- Nettoyage automatique des ressources (stream, tracks)

##### **3. IAstedStorageService** (`src/services/iAstedStorageService.ts`)
Service de persistance des conversations et fichiers audio.

**Fonctionnalit√©s :**
- Sauvegarde des conversations dans Supabase
- Upload des fichiers audio dans le bucket `conversations`
- G√©n√©ration d'URLs publiques temporaires
- M√©tadonn√©es : session_id, mode, timestamps, response_time_ms

#### **Composants React**

##### **IAstedFloatingButton** (`src/components/admin/IAstedFloatingButton.tsx`)
Composant principal du bouton flottant et de l'interface de chat.

**√âtats React :**
```typescript
- isOpen: boolean          // Interface chat ouverte
- mode: 'voice' | 'text'   // Mode d'interaction
- isListening: boolean     // En √©coute active
- isSpeaking: boolean      // En train de parler
- isProcessing: boolean    // Traitement en cours
- messages: Message[]      // Historique de la conversation
- position: {x, y}         // Position du bouton
```

**Gestion du drag-and-drop :**
- D√©tection des √©v√©nements mouse et touch
- Contraintes dans les limites de l'√©cran
- Sauvegarde de la position dans localStorage
- Pr√©vention des clics apr√®s drag

**Gestion des clics :**
- Simple clic : Mode texte (ouvre l'interface)
- Double clic : Mode vocal (lance la conversation)
- Fen√™tre de d√©tection : 350ms

##### **IAstedButton** (`src/components/ui/iAstedButton.tsx`)
Bouton sph√©rique avec animations organiques complexes.

**Animations CSS :**
- `global-heartbeat` : Battement de c≈ìur global (2.8s)
- `membrane-palpitation` : Pulsations de membranes (intensifi√© selon √©tat)
- `wave-emission` : √âmission d'ondes (synchronis√© avec battements)
- `morphing-bg` : Fond morphing multicolore (25s)
- `muscle-contraction` : Contraction au clic (1.2s)

**Classes d'√©tats vocaux :**
- `.voice-listening` : Animations acc√©l√©r√©es (0.6s-0.8s)
- `.voice-speaking` : Animations rythm√©es (0.4s-0.5s)
- Normal : Animations lentes (2.8s)

**Props :**
```typescript
{
  onClick?: () => void
  size?: 'sm' | 'md' | 'lg'
  voiceListening?: boolean
  voiceSpeaking?: boolean
  voiceProcessing?: boolean
  isInterfaceOpen?: boolean
}
```

### **üé§ D√©tection vocale avanc√©e (VAD)**

#### **Voice Activity Detection (VAD) adaptatif**
Syst√®me de d√©tection automatique de fin de parole avec adaptation au volume.

**Param√®tres :**
- **Fr√©quence d'analyse** : 100ms
- **Taille du buffer** : 2048 samples (FFT)
- **Dur√©e silence** : 800ms (plus r√©actif)
- **Dur√©e parole minimale** : 500ms

**Seuils adaptatifs :**
```typescript
RMS_SPEECH = max(0.015, maxRMS * 0.15)  // D√©tection de parole
RMS_SILENCE = RMS_SPEECH * 0.5          // D√©tection de silence
```

**√âtats de d√©tection :**
1. **Aucune parole** : Attente de signal audio
2. **Parole d√©tect√©e** : D√©but d'√©nonc√© (RMS > seuil)
3. **Zone grise** : Entre parole et silence (incr√©ment lent)
4. **Silence** : Fin d'√©nonc√© confirm√©e (800ms continu)

**Calcul RMS (Root Mean Square) :**
```typescript
const rms = Math.sqrt(sumSquares / bufferLength)
```

**Logs de debug :**
- üó£Ô∏è Parole d√©tect√©e - D√©but d'√©nonc√©
- üîá Silence: XXXms / 800ms (progression)
- ‚úÖ Fin de parole d√©tect√©e - Traitement...
- üìä Seuils adapt√©s: Parole=0.XXXX, Silence=0.XXXX

### **üîå Edge Functions Supabase**

#### **1. iasted-chat** (`supabase/functions/iasted-chat/index.ts`)
Gestion des conversations textuelles avec l'IA.

**Fonctionnalit√©s :**
- Authentification JWT et r√©cup√©ration du r√¥le utilisateur
- Adaptation du syst√®me prompt selon le r√¥le
- Appel √† Lovable AI (google/gemini-2.5-flash)
- Gestion des erreurs et logs d√©taill√©s

**Configuration :**
```toml
[functions.iasted-chat]
verify_jwt = true  # Authentification requise
```

#### **2. iasted-stt** (`supabase/functions/iasted-stt/index.ts`)
Transcription audio (Speech-to-Text) via Deepgram.

**Fonctionnalit√©s :**
- R√©ception d'audio en base64
- Conversion et envoi √† Deepgram API
- Retour de la transcription en texte
- Gestion des erreurs avec fallback

**Configuration :**
```toml
[functions.iasted-stt]
verify_jwt = true
```

**Variables d'environnement :**
- `DEEPGRAM_API_KEY` : Cl√© API Deepgram

#### **3. iasted-tts** (`supabase/functions/iasted-tts/index.ts`)
Synth√®se vocale (Text-to-Speech) via ElevenLabs.

**Fonctionnalit√©s :**
- R√©ception de texte √† synth√©tiser
- Appel √† ElevenLabs API avec voix Charlotte
- Retour de l'audio en base64
- Optimisation de la qualit√© vocale

**Configuration :**
```toml
[functions.iasted-tts]
verify_jwt = true
```

**Variables d'environnement :**
- `ELEVENLABS_API_KEY` : Cl√© API ElevenLabs

**Param√®tres de synth√®se :**
```typescript
{
  model_id: "eleven_multilingual_v2",
  voice_settings: {
    stability: 0.5,
    similarity_boost: 0.75,
    style: 0.0,
    use_speaker_boost: true
  }
}
```

### **üíæ Structure de donn√©es**

#### **Conversation Message**
```typescript
interface Message {
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
  mode: 'voice' | 'text'
  audioUrl?: string
}
```

#### **Sauvegarde Supabase**
```typescript
{
  session_id: string           // UUID de la session
  mode: 'voice' | 'text'       // Mode d'interaction
  user_message: string         // Message utilisateur
  user_message_transcription?: string  // Transcription si vocal
  assistant_message: string    // R√©ponse de l'assistant
  assistant_audio_url?: string // URL audio si vocal
  context_data: {
    timestamp: string
    sessionId: string
  }
  response_time_ms: number     // Temps de r√©ponse
}
```

### **üîß Configuration et personnalisation**

#### **Voix ElevenLabs disponibles**
- **Charlotte** (XB0fDUnXU5powFXDhCwa) : Voix f√©minine FR √©l√©gante [D√âFAUT]
- **Aria** (9BWtsMINqrJLrRacOk9x) : Voix f√©minine EN naturelle
- **Roger** (CwhRBWXzGAHq8TQ4Fs17) : Voix masculine EN professionnelle

#### **Mod√®les IA disponibles (Lovable AI)**
- **google/gemini-2.5-flash** : Rapide, efficace, multimodal [D√âFAUT]
- **google/gemini-2.5-pro** : Plus puissant, raisonnement complexe
- **openai/gpt-5-mini** : √âquilibr√©, bon rapport qualit√©/prix

#### **Personnalisation du comportement**
Modifier les constantes dans `IAstedFloatingButton.tsx` :
```typescript
const SILENCE_DURATION = 800        // Dur√©e silence (ms)
const MIN_SPEECH_DURATION = 500     // Dur√©e parole min (ms)
const RMS_SPEECH = 0.018            // Seuil activation parole
const RMS_SILENCE = 0.01            // Seuil d√©tection silence
```

### **üêõ Debugging et logs**

#### **Console logs disponibles**
```typescript
üé≠ iAsted Button State      // √âtat du bouton (ic√¥ne, animation)
üéôÔ∏è Mode vocal activ√©        // Activation mode vocal
üó£Ô∏è Parole d√©tect√©e          // D√©tection de parole
üîá Silence: XXXms           // Progression du silence
‚úÖ Fin de parole d√©tect√©e   // Fin confirm√©e
üí¨ iAsted parle             // Synth√®se vocale en cours
üß† iAsted r√©fl√©chit         // Traitement IA
ü§ñ Demande √† l'IA           // Envoi √† l'API
‚úÖ R√©ponse IA re√ßue         // R√©ponse re√ßue
üìä Seuils adapt√©s           // Adaptation VAD
```

#### **Gestion des erreurs**
Toutes les erreurs sont captur√©es et affich√©es via toasts :
- Erreur acc√®s microphone
- Erreur transcription (Deepgram indisponible)
- Erreur synth√®se vocale (ElevenLabs indisponible)
- Erreur API IA (timeout, rate limit)
- Erreur sauvegarde conversation

### **üöÄ Am√©liorations futures possibles**

1. **Streaming de r√©ponses** : Afficher la r√©ponse IA en temps r√©el
2. **Multi-langue** : Support EN, ES en plus du FR
3. **Commandes vocales** : "iAsted, ouvre les signalements"
4. **Historique persistant** : Reprise de conversation apr√®s d√©connexion
5. **Mode dict√©e** : Transcription continue sans limite
6. **Personnalisation voix** : Choix de la voix par l'utilisateur
7. **Raccourcis clavier** : Ctrl+Space pour activer le vocal
8. **Mode mains-libres** : Activation par mot-cl√© "Hey iAsted"

---

### üèóÔ∏è **Architecture technique**
- **Frontend**: React 18 + TypeScript + Vite + Tailwind CSS
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **D√©ploiement**: Netlify + Supabase Cloud
- **S√©curit√©**: RLS + JWT + Chiffrement AES-256

## üìö **Documentation compl√®te**

### **Architecture et Plan**
- **[PLAN-DETAILLE-NDJOBI.md](./PLAN-DETAILLE-NDJOBI.md)** - Plan d√©taill√© complet de l'application
- **[ARCHITECTURE-DIAGRAM.md](./ARCHITECTURE-DIAGRAM.md)** - Diagrammes d'architecture du syst√®me
- **[DOCUMENTATION-COMPLETE.md](./DOCUMENTATION-COMPLETE.md)** - Index de toute la documentation

### **Modules fonctionnels**
- **[VOLET-SIGNALEMENTS-DETAILLE.md](./VOLET-SIGNALEMENTS-DETAILLE.md)** - Syst√®me de signalements de corruption
- **[VOLET-PROJET-DETAILLE.md](./VOLET-PROJET-DETAILLE.md)** - Protection de projets et cr√©ations
- **[MODULE-XR7-DETAILLE.md](./MODULE-XR7-DETAILLE.md)** - Syst√®me d'urgence et protocoles sp√©ciaux

### **Guides techniques**
- **[CORRECTIONS-SIGNALEMENTS.md](./CORRECTIONS-SIGNALEMENTS.md)** - Corrections apport√©es au syst√®me
- **[TEST-SIGNALEMENTS.md](./TEST-SIGNALEMENTS.md)** - Guide de test des fonctionnalit√©s

## üöÄ **Installation et D√©veloppement**

### **Pr√©requis**
- **Node.js** 18+ et **npm** ou **bun**
- **Git** pour le contr√¥le de version
- **Supabase CLI** pour la base de donn√©es locale

### **Installation**
```bash
# 1. Cloner le repository
git clone https://github.com/okatech-org/ndjobi.git
cd ndjobi

# 2. Installer les d√©pendances
bun install
# ou
npm install

# 3. Configurer l'environnement
cp env.template .env.local
# √âditer .env.local avec vos cl√©s Supabase

# 4. D√©marrer Supabase local
supabase start

# 5. Appliquer les migrations
supabase db reset

# 6. G√©n√©rer les types TypeScript
supabase gen types typescript --local > src/integrations/supabase/types.ts

# 7. D√©marrer le serveur de d√©veloppement
bun run dev
# ou
npm run dev
```

### **Scripts disponibles**
```bash
# D√©veloppement
bun run dev          # Serveur de d√©veloppement
bun run build        # Build de production
bun run preview      # Preview du build

# Base de donn√©es
supabase start       # D√©marrer Supabase local
supabase db reset    # Reset de la base
supabase gen types   # G√©n√©rer les types TypeScript

# Tests et qualit√©
bun run test         # Tests unitaires
bun run lint         # Linting
bun run type-check   # V√©rification TypeScript
```

### **Structure du projet**
```
src/
‚îú‚îÄ‚îÄ components/          # Composants r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ ai-agent/       # Chatbot IA pour signalements
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/      # Composants sp√©cifiques aux dashboards
‚îÇ   ‚îî‚îÄ‚îÄ ui/             # Composants UI de base (shadcn/ui)
‚îú‚îÄ‚îÄ pages/              # Pages de l'application
‚îÇ   ‚îî‚îÄ‚îÄ dashboards/     # Dashboards par r√¥le
‚îú‚îÄ‚îÄ hooks/              # Hooks personnalis√©s React
‚îú‚îÄ‚îÄ services/           # Services m√©tier
‚îú‚îÄ‚îÄ types/              # Types TypeScript
‚îî‚îÄ‚îÄ utils/              # Utilitaires
```

## üåê **D√©ploiement**

### **Production**
- **Frontend** : D√©ploy√© automatiquement sur Netlify
- **Backend** : Supabase Cloud
- **Domaine** : Configur√© via Netlify

### **Staging**
- **Frontend** : Netlify Preview pour les PR
- **Backend** : Supabase Cloud (environnement de test)

## üìû **Support**

- **Issues** : [GitHub Issues](https://github.com/okatech-org/ndjobi/issues)
- **Documentation** : Voir les fichiers .md dans le repository
- **Contact** : Via les issues GitHub

## How can I edit this code?

There are several ways of editing your application.

**Use Lovable**

Simply visit the [Lovable Project](https://lovable.dev/projects/b4ae50a0-839f-4357-b969-63ae618cd959) and start prompting.

Changes made via Lovable will be committed automatically to this repo.

**Use your preferred IDE**

If you want to work locally using your own IDE, you can clone this repo and push changes. Pushed changes will also be reflected in Lovable.

The only requirement is having Node.js & npm installed - [install with nvm](https://github.com/nvm-sh/nvm#installing-and-updating)

Follow these steps:

```sh
# Step 1: Clone the repository using the project's Git URL.
git clone <YOUR_GIT_URL>

# Step 2: Navigate to the project directory.
cd <YOUR_PROJECT_NAME>

# Step 3: Install the necessary dependencies.
npm i

# Step 4: Start the development server with auto-reloading and an instant preview.
npm run dev
```

**Edit a file directly in GitHub**

- Navigate to the desired file(s).
- Click the "Edit" button (pencil icon) at the top right of the file view.
- Make your changes and commit the changes.

**Use GitHub Codespaces**

- Navigate to the main page of your repository.
- Click on the "Code" button (green button) near the top right.
- Select the "Codespaces" tab.
- Click on "New codespace" to launch a new Codespace environment.
- Edit files directly within the Codespace and commit and push your changes once you're done.

## What technologies are used for this project?

This project is built with:

- Vite
- TypeScript
- React
- shadcn-ui
- Tailwind CSS

## How can I deploy this project?

Simply open [Lovable](https://lovable.dev/projects/b4ae50a0-839f-4357-b969-63ae618cd959) and click on Share -> Publish.

## Can I connect a custom domain to my Lovable project?

Yes, you can!

To connect a domain, navigate to Project > Settings > Domains and click Connect Domain.

Read more here: [Setting up a custom domain](https://docs.lovable.dev/features/custom-domain#custom-domain)
